@page "/"
@using Microsoft.JSInterop
@using Pmjay.Api.Data
@using Pmjay.Web.ApiClients
@inject HomeApiClient Api
@inject IJSRuntime JS

<div class="home-wrapper container-fluid">

    <!-- ================= FIXED HEADER ================= -->
    <div class="pmjay-header fixed-top d-flex align-items-center p-3 shadow-sm bg-white">
        <!-- Left Logo -->
        <div class="flex-shrink-0">
            <img src="PMJAYl.png" class="gov-logo" />
        </div>

        <!-- Center Title -->
        <div class="flex-grow-1 text-center">
            <h2 class="mb-1 fw-bold text-primary pmjay-title">
                आयुष्मान भारत – प्रधानमंत्री जन आरोग्य योजना (AB-PMJAY)
            </h2>
            <div class="fs-6 fw-semibold text-secondary">
                पात्र लाभार्थियों की सूची (डेटा प्रबंधन प्रणाली) जनपद आगरा, उत्तर प्रदेश
            </div>
            <div class="fs-7 fw-semibold text-secondary">
                टोल फ्री हेल्पलाइन न०-1800 1800 4444/14555
            </div>
        </div>

        <!-- Right Logos + App Links -->
        <div class="flex-shrink-0 d-flex align-items-center right-logo">
            <!-- UP Seal Logo -->
            <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Seal_of_Uttar_Pradesh.svg" class="gov-logo me-3" />

        </div>
    </div>

    <!-- Spacer for fixed header -->
    <div class="pmjay-header-spacer"></div>

    <!-- ================= FILTER HEADER ================= -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center">
            <h6 class="mb-0 fw-bold text-primary">Filter Criteria</h6>

            @if (ActiveFilterCount > 0)
            {
                <span class="badge bg-info ms-2">
                    @ActiveFilterCount Filters
                </span>
            }
        </div>

       <button class="btn btn-sm btn-outline-primary"
        @onclick="ToggleFilters">
    @(ShowFilters ? "Hide Filters" : "Show Filters")
</button>
    </div>
    @if (ShowFilters)
{
    <!-- ================= FILTER PANEL ================= -->
    <div id="filtersCollapse" class="collapse show">
        <div class="card pmjay-filter-card shadow-sm mb-3">
            <div class="card-body">
                <div class="row g-3 align-items-end">

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Search</label>
                        <input class="form-control pmjay-input"
                               @bind="Search"
                               placeholder="Search by name or family ID" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Block / ULB</label>
                        <select class="form-select pmjay-input" @bind="Block">
                            <option value="">-- Select Block --</option>
                            @foreach (var b in Blocks)
                            {
                                <option value="@b">@b</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Village / Mohalla (ULB)</label>
                        <input class="form-control pmjay-input"
                               placeholder="Type village name"
                               @bind="Village"
                               @bind:event="oninput"
                               disabled="@string.IsNullOrWhiteSpace(Block)" />

                        @if (!string.IsNullOrWhiteSpace(Village) && Village.Length < 3)
                        {
                            <small class="text-danger">Minimum 3 characters required</small>
                        }
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Source Type</label>
                        <select class="form-select pmjay-input" @bind="Source">
                            <option value="">All</option>
                            <option value="SECC">SECC</option>
                            <option value="TPHH">TPHH</option>
                            <option value="MMJAA">MMJAA</option>
                            <option value="STPHH">STPHH</option>
                            <option value="BOCW">BOCW</option>
                                <option value="ANTYODAY">ANTYODAY</option>
                                <option value="ASHA">ASHA</option>
                                <option value="AWH">AWH</option>
                                <option value="AWW">AWW</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Member Status</label>
                        <select class="form-select pmjay-input" @bind="MemberStatus">
                            <option value="">All</option>
                            <option value="EKYC">Left Out Data</option>
                            <option value="Approved">Approved</option>
                            <option value="Applied">Applied</option>
                            <option value="Disabled">Disabled</option>
                        </select>
                    </div>

                    <div class="col-12 col-md-4 d-flex flex-column flex-md-row gap-2">
                        <button class="btn btn-primary pmjay-btn w-100"
                                @onclick="ApplyFiltersClicked"
                                disabled="@IsApplyDisabled">
                            Apply Filter
                        </button>

                        <button class="btn btn-outline-secondary pmjay-btn w-100"
                                @onclick="Reset">
                            Reset
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>
    }
 
    <!-- ================= SUMMARY ================= -->
    <div class="row g-3 mb-3">
     <div class="row g-3">
            <div class="row g-3">
                <div class="col-md-3 col-sm-6">
                    <div class="stat-card gradient-blue">
                        <div class="card-body text-center">
                            <div class="stat-title">Total Families</div>
                            <div class="stat-number">@Summary.TotalFamilies</div>
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6">
                    <div class="stat-card gradient-green">
                        <div class="card-body text-center">
                            <div class="stat-title">Total Members</div>
                            <div class="stat-number">@Summary.TotalMembers</div>
                            <div class="stat-icon">
                                <i class="fas fa-user-friends"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6">
                    <div class="stat-card gradient-yellow">
                        <div class="card-body text-center">
                            <div class="stat-title">Covered Members</div>
                            <div class="stat-number">@Summary.CoveredMembers</div>
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-3 col-sm-6">
                    <div class="stat-card gradient-purple">
                        <div class="card-body text-center">
                            <div class="stat-title">Covered Families</div>
                            <div class="stat-number">@Summary.CoveredFamilies</div>
                            <div class="stat-icon">
                                <i class="fas fa-home"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
</div>
    </div>
    <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="d-flex align-items-center gap-2">
        <span class="small text-muted">Rows per page:</span>
        <select class="form-select form-select-sm w-auto"
                    @bind="PageSize"
                    @bind:after="OnRowsPerPageChanged">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>

    <div class="small text-muted">
            Showing page @CurrentPage of @TotalPages
    </div>
</div>
    <!-- ================= TABLE ================= -->
    <div class="container-fluid px-2" id="printSection">
        <div class="card pmjay-table-card shadow-sm mb-3">
            <!-- Table Header -->
            <div class="card-header bh-header">
                <h5>Beneficiary Data</h5>

                <div class="actions">
                    <button class="btn btn-success" @onclick="ExportCsv">
                        <i class="bi bi-download"></i>
                        <span>CSV</span>
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="Print">
                        <i class="bi bi-printer"></i>
                        <span>Print</span>
                    </button>
                </div>
            </div>


            <!-- Table Body -->
            <div class="card-body table-responsive px-0">
                <table class="table pmjay-table align-middle mb-0">
                    <thead>
                        <tr>
                            @foreach (var h in Headers)
                            {
                                <th class="text-nowrap fw-semibold">
                                    @(HeaderDisplayNames.ContainsKey(h) ? HeaderDisplayNames[h] : h)
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @if (DisplayRows?.Count > 0)
                        {
                            @foreach (var r in DisplayRows)
                            {
                                <tr>
                                    @foreach (var h in Headers)
                                    {
                                        var cellValue = GetValue(r, h)?.ToString()?.Trim();

                                        <td>
                                            @{
                                                bool isCardStatusColumn = h?.ToString()?.Trim()?.ToLower() == "card_status_member";
                                            }

                                            @if (isCardStatusColumn && string.IsNullOrEmpty(cellValue))
                                            {
                                                <a href="https://beneficiary.nha.gov.in" target="_blank" title="Do eKYC" class="badge badge-warning kyc-badge">
                                                    KYC Needed
                                                </a>
                                            }
                                            else
                                            {
                                                @FormatValue(h, cellValue)
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="@Headers.Count" class="text-center text-muted py-4">
                                    No data to display
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-center gap-2 my-3">
                <button class="btn btn-outline-secondary" @onclick="First">First</button>
                <button class="btn btn-outline-secondary" @onclick="Prev">Prev</button>
                <span class="align-self-center">Page @CurrentPage of @TotalPages</span>
                <button class="btn btn-outline-secondary" @onclick="Next">Next</button>
                <button class="btn btn-outline-secondary" @onclick="Last">Last</button>
            </div>
        </div>
    </div>

   
    <!-- ================= LOADER ================= -->
   @if (IsLoading)
{
    <div class="loading-overlay">
        <div class="loader-card text-center">
            <div class="chakra-spin mb-3"></div>

            <div class="fw-semibold text-primary fs-5">
                कृपया प्रतीक्षा करें…
            </div>

            <div class="text-muted small mt-1">
                आयुष्मान भारत (PMJAY) डेटा सुरक्षित रूप से लोड हो रहा है
            </div>

            <div class="progress mt-3" style="height:6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated"
                     style="width: 100%"></div>
            </div>

            <div class="text-muted small mt-2">
                This may take a few seconds. Thank you for your patience.
            </div>
            <div class="text-muted small mt-3">
    यह सरकारी डेटा है। कृपया दुरुपयोग न करें।
</div>
        </div>
    </div>
}

</div>
<!-- ================= GOVERNMENT DISCLAIMER ================= -->
<div class="gov-disclaimer mt-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body text-center">

            <!-- English -->
            <p class="mb-1 fw-semibold text-danger">
                ⚠️ Government Data Disclaimer
            </p>
            <p class="mb-2 small text-muted">
                This is <strong>Government of India / State Government data</strong>.
                Any <strong>unauthorized access, copying, sharing, or misuse</strong> of this data
                is strictly prohibited and is punishable under applicable
                <strong>IT Act & Government rules</strong>.
                Legal action will be taken against violators.
            </p>

            <!-- Divider -->
            <hr class="my-2">

            <!-- Hindi -->
            <p class="mb-0 small text-muted">
                यह <strong>भारत सरकार / राज्य सरकार</strong> का डेटा है।
                इस डेटा का <strong>अनधिकृत उपयोग, प्रतिलिपि, साझा करना या दुरुपयोग</strong>
                दंडनीय अपराध है।
                दोषियों के विरुद्ध <strong>आईटी अधिनियम एवं प्रचलित सरकारी नियमों</strong> के अंतर्गत
                विधिक कार्रवाई की जाएगी।
            </p>

        </div>
    </div>
</div>
<footer class="bg-light border-top text-center text-secondary small py-2 mt-3">
    © @DateTime.Now.Year Ayushman Bharat – Pradhan Mantri Jan Arogya Yojana (AB-PMJAY), Agra District |
    All rights reserved | Developed & Maintained by Office Of The Chief Medical Officer, Agra
</footer>
@code {

    int RowsPerPage = 10;   // default
    readonly List<string> Blocks = new()
 {
 "ACHHNERA",
 "AKOLA",
 "BAH",
 "BARAULI AHIR",
 "BICHPURI",
 "ETMADPUR",
 "FATEHABAD",
 "FATEHPUR SIKRI",
 "JAGNER",
 "JAITPUR KALAN",
 "KHANDAULI",
 "KHERAGARH",
 "PINAHAT",
 "SAIYAN",
 "SHAMSABAD",
 "AGRA (M Corp.)",
  "AGRA (CB)",

        // --- Urban Local Bodies ---
        "Fatehpur Sikri (NPP)",
        "Bah (NPP)",
        "Shamsabad (NPP)",
        "Achhnera (NPP)",
        "Kheragarh (NP)",
        "Swamibagh (NP)",
        "Fatehabad (NP)",
        "Dayalbagh (NP)",
        "Pinahat (NP)",
        "Jagner (NP)",
        "Etmadpur (NPP)",
        "Kiraoali (NP)"
    };

    List<string> Headers = new()
 {
 "src_family_id",
 // "src_member_id",
 "name",
 "relation",
 "father_guardian_name",
 // "rural_urban_flag",
 // "district_name",
 "blockname",
 "source_address",
 // "addressasperadhaarofapproved",
 // "village_ward_lgd_code",
 "source_type",
  "card_status_member"
 // "card_status_family",
 // "memberbelongtozeropovery"
 };
    readonly Dictionary<string, string> HeaderDisplayNames = new()
    {
        { "src_family_id", "Family ID" },
        { "name", "Member Name" },
        { "relation", "Relation" },
        { "father_guardian_name", "Father/Guardian Name" },
        { "blockname", "Block Name" },
        { "source_address", "Source Address" },
        { "source_type", "Source Type" },
        { "card_status_member", "Card Status" }
    };

    List<Dictionary<string, object?>> Rows = new();
    List<Dictionary<string, object?>> DisplayRows = new();

    SummaryDto Summary = new();

    // Filters
    string Search = string.Empty;
    string District = string.Empty;
    string Block { get; set; } = string.Empty;
    string Village { get; set; } = string.Empty;
    string RU { get; set; } = string.Empty;
    string Source { get; set; } = string.Empty;
    string MemberStatus { get; set; } = string.Empty;
    string FamilyStatus { get; set; } = string.Empty;

    int Total = 0;
    int CurrentPage = 1;
    int PageSize { get; set; } = 10; // default to10
    int TotalPages => Math.Max(1, (int)Math.Ceiling((double)Total / PageSize));

    // Loading flag for overlay
    bool IsLoading { get; set; } = false;


    int TotalFamilies => Summary.TotalFamilies;
    int TotalMembers => Summary.TotalMembers;
    int CoveredMembers => Summary.CoveredMembers;
    int CoveredFamilies => Summary.CoveredFamilies;

    // debug message to verify handler runs
    string LastAction { get; set; } = string.Empty;
    bool IsApplyDisabled =>
    string.IsNullOrWhiteSpace(Block) ||
    (!string.IsNullOrWhiteSpace(Village) && Village.Length < 3);

    protected override async Task OnInitializedAsync()
    {
        await LoadPage();
    }
    async Task OnRowsPerPageChanged()
    {
        CurrentPage = 1;
        await LoadPage();
    }
    async Task LoadPage()
    {
        IsLoading = true;
        await InvokeAsync(StateHasChanged);   // 🔹 force render loader immediately

        try
        {
            var summaryTask = Api.GetSummaryAsync(
                Block, Village, RU,
                Source, MemberStatus,
                FamilyStatus, Search);

            var rowsTask = Api.GetPageAsync(
                CurrentPage, PageSize,
                Block, Village, RU,
                Source, MemberStatus,
                FamilyStatus, Search);

            // 🚀 Run both API calls in parallel
            await Task.WhenAll(summaryTask, rowsTask);

            Summary = await summaryTask;
            Rows = await rowsTask;

            Total = Summary.TotalMembers;
            DisplayRows = Rows.ToList();
        }
        finally
        {
            IsLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    bool ShowFilters = true;

    void ToggleFilters()
    {
        ShowFilters = !ShowFilters;
    }
    void ApplyFilters()
    {
        // Guard against null Rows
        if (Rows == null)
        {
            DisplayRows = new List<Dictionary<string, object?>>();
            return;
        }

        DisplayRows = Rows.Where(RowMatchesFilters).ToList();
        StateHasChanged();
    }

    bool RowMatchesFilters(Dictionary<string, object?> r)
    {
        string Get(string key) => (GetValue(r, key) ?? string.Empty).ToString();

        // Normalize inputs
        var search = (Search ?? string.Empty).Trim();
        var district = (District ?? string.Empty).Trim();
        var block = (Block ?? string.Empty).Trim();
        var village = (Village ?? string.Empty).Trim();
        var ru = (RU ?? string.Empty).Trim();
        var source = (Source ?? string.Empty).Trim();
        var memberStatus = (MemberStatus ?? string.Empty).Trim();
        var familyStatus = (FamilyStatus ?? string.Empty).Trim();

        // Search: match name OR family id
        if (!string.IsNullOrWhiteSpace(search))
        {
            var name = Get("name");
            var fid = Get("src_family_id");
            if (name.IndexOf(search, StringComparison.OrdinalIgnoreCase) < 0 && fid.IndexOf(search, StringComparison.OrdinalIgnoreCase) < 0)
                return false;
        }

        if (!IsMatch(district, () => string.Equals(Get("district_name"), district, StringComparison.OrdinalIgnoreCase)))
            return false;
        if (!IsMatch(block, () => string.Equals(Get("blockname"), block, StringComparison.OrdinalIgnoreCase)))
            return false;
        if (!IsMatch(village, () => Get("village_ward_lgd_code").IndexOf(village, StringComparison.OrdinalIgnoreCase) >= 0))
            return false;
        if (!IsMatch(ru, () => string.Equals(Get("rural_urban_flag"), ru, StringComparison.OrdinalIgnoreCase)))
            return false;
        if (!IsMatch(source, () => string.Equals(Get("source_type"), source, StringComparison.OrdinalIgnoreCase)))
            return false;
        if (!IsMatch(memberStatus, () => string.Equals(Get("card_status_member"), memberStatus, StringComparison.OrdinalIgnoreCase)))
            return false;
        if (!IsMatch(familyStatus, () => string.Equals(Get("card_status_family"), familyStatus, StringComparison.OrdinalIgnoreCase)))
            return false;

        return true;
    }

    static bool IsMatch(string filter, Func<bool> matchFunc)
    {
        return string.IsNullOrWhiteSpace(filter) || matchFunc();
    }

    // Handler for Block dropdown change: request server-side filtered data
    async Task OnBlockChanged(ChangeEventArgs e)
    {
        // ensure Block gets the selected value (bind already does this but keep in sync)
        Block = (e?.Value?.ToString() ?? string.Empty).Trim();
        LastAction = $"Block changed to '{Block}' at {DateTime.UtcNow:O}";
        CurrentPage = 1;
        // reload page from the server with new Block filter so paging and summary are correct
        await LoadPage();
    }



    async Task ApplyFiltersClicked()
    {
        // diagnostic: set message and log to browser console
        LastAction = $"ApplyFiltersClicked invoked at {DateTime.UtcNow:O}";
        Console.WriteLine(LastAction);      

        CurrentPage = 1;
        await LoadPage();
    }

    string? GetValue(Dictionary<string, object?> row, string key)
    {
        if (row == null) return null;
        if (row.TryGetValue(key, out var v)) return v?.ToString();
        // try case-insensitive
        var found = row.FirstOrDefault(kv => string.Equals(kv.Key, key, StringComparison.OrdinalIgnoreCase));
        return found.Equals(default(KeyValuePair<string, object?>)) ? null : found.Value?.ToString();
    }
    MarkupString FormatValue(string header, object? value)
{
    if (header == "card_status_member")
    {
        var text = value switch
        {
            null => "KYC Needed",
            "DO Ekyc" => "KYC Needed",
            "S" => "Applied",
            "Approved" => "Approved",
            "Disabled" => "Disabled",
            _ => value?.ToString() ?? ""
        };

        var css = text switch
        {
            "Approved" => "badge bg-success",
            "Applied" => "badge bg-warning text-dark",
            "Disabled" => "badge bg-danger",
            _ => "badge bg-secondary"
        };

        return new MarkupString($"<span class='{css}'>{text}</span>");
    }

    return new MarkupString(value?.ToString() ?? "");
}
    int ComputeTotalFamilies()
    {
        return DisplayRows.Select(r => GetValue(r, "src_family_id")).Where(s => !string.IsNullOrEmpty(s)).Distinct(StringComparer.OrdinalIgnoreCase).Count();
    }

    async Task Prev() { if (CurrentPage > 1) { CurrentPage--; await LoadPage(); } }
    async Task Next() { if (CurrentPage < TotalPages) { CurrentPage++; await LoadPage(); } }
    async Task First() { if (CurrentPage != 1) { CurrentPage = 1; await LoadPage(); } }
    async Task Last() { if (CurrentPage != TotalPages) { CurrentPage = TotalPages; await LoadPage(); } }

    async Task ExportCsv()
    {
        var csv = new List<string>();

        // Header
        csv.Add(string.Join(",", Headers.Select(h => $"\"{h}\"")));

        // Rows
        foreach (var r in DisplayRows)
        {
            var row = Headers.Select(h =>
            {
                var value = GetValue(r, h)?.ToString() ?? string.Empty;
                value = value.Replace("\"", "\"\""); // CSV escaping
                return $"\"{value}\"";
            });

            csv.Add(string.Join(",", row));
        }

        var content = string.Join("\r\n", csv);

        await JS.InvokeVoidAsync(
            "downloadCsv",
            content,
            "PMJAY_Agra_Data.csv"
        );
    }

    int ActiveFilterCount =>
    new[]
    {
        Search,
        Block,
        Village,
        Source,
        MemberStatus
    }.Count(x => !string.IsNullOrWhiteSpace(x));
    async Task Print()
    {
        await JS.InvokeVoidAsync("printPage");

    }

    // Reset helper
    void Reset()
    {
        // Clear all filters
        Search = string.Empty;
        Block = string.Empty;
        Village = string.Empty;
        RU = string.Empty;
        Source = string.Empty;
        MemberStatus = string.Empty;
        FamilyStatus = string.Empty;
        LastAction = "Filters reset";
        DisplayRows = new List<Dictionary<string, object?>>();
        Summary = new SummaryDto();

    }
}

<script>
    window.initInfiniteScroll=function(dotnet){const s=document.getElementById('scrollSentinel');new IntersectionObserver(e=>{if(e[0].isIntersecting)dotnet.invokeMethodAsync('LoadNextPage')}).observe(s)}
</script>