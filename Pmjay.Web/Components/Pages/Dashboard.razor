@page "/Dashboard"
<h3>Dashboard</h3>
@attribute [AllowAnonymous]
@layout Layout.EmptyLayout
@using Microsoft.AspNetCore.Authorization
@inject NavigationManager NavigationManager
@using Pmjay.Api.Data
@using Pmjay.Web.ApiClients
@using Pmjay.Web.Data
@inject DashboardApiService Api

    <!-- dashboard UI -->
<div class="home-wrapper container-fluid">
    <!-- ================= HEADER ================= -->
    <div class="pmjay-header fixed-top d-flex align-items-center p-3 shadow-sm bg-white">
        <!-- Left Logo -->
        <div class="flex-shrink-0">
            <img src="PMJAYl.png" class="gov-logo" />
        </div>

        <!-- Center Title -->
        <div class="flex-grow-1 text-center">
            <h2 class="mb-1 fw-bold text-primary pmjay-title">
                आयुष्मान भारत – प्रधानमंत्री जन आरोग्य योजना (AB-PMJAY)
            </h2>
            <div class="fs-6 fw-semibold text-secondary">
                पात्र लाभार्थियों की सूची (डेटा प्रबंधन प्रणाली) जनपद आगरा, उत्तर प्रदेश
            </div>
            <div class="fs-7 fw-semibold text-secondary">
                टोल फ्री हेल्पलाइन न०-1800 1800 4444/14555
            </div>
        </div>

        <!-- Right Logos + App Links -->
        <div class="flex-shrink-0 d-flex align-items-center right-logo">
            <!-- UP Seal Logo -->

            <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Seal_of_Uttar_Pradesh.svg" class="gov-logo me-3" />

        </div>
    </div>
    <div style="height:50px"></div>
    <div class="alert alert-info small mt-4 text-center">
        यह डैशबोर्ड केवल सूचना के उद्देश्य हेतु है। आंकड़े वास्तविक समय से भिन्न हो सकते हैं। Note:Block / Family Wise Ayushman Card Status (AB-PMJAY and MMJAA schemes data excluding SECC, UO, PDDU, Patrakaar, PVTG, and VVS categories)

    </div>
@if (IsLoading)
{
        <div class="text-center my-5">
            <div class="spinner-border text-primary"></div>
            <div class="small">Loading dashboard...</div>
        </div>
}
else
{
    <!-- ================= KPI SUMMARY ================= -->
    <div class="container-fluid mb-3">
            <div class="container-fluid mb-4">
                <div class="row g-3 justify-content-center">
                    <h4 class="fw-bold text-primary text-center mb-3">
                        जनपद की कवरेज स्थिति
                    </h4>
                    <div class="col-md-4 text-center">
                        <div class="ring-wrapper">
                            <div class="progress-ring"
                                 style="--value:@DistrictFamilyPercent">
                                <span>@DistrictFamilyPercent%</span>
                            </div>
                            <div class="small fw-semibold mt-2">
                                District Family Coverage
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 text-center">
                        <div class="ring-wrapper">
                            <div class="progress-ring blue"
                                 style="--value:@DistrictMemberPercent">
                                <span>@DistrictMemberPercent%</span>
                            </div>
                            <div class="small fw-semibold mt-2">
                                District Member Coverage
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        <div class="row g-2 text-center">
            <div class="col-md-3">
                <div class="kpi-box bg-primary text-white">
                        <div class="kpi-value">@TotalFamilies</div>
                    <div class="kpi-label">कुल पात्र परिवार</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-box bg-success text-white">
                    <div class="kpi-value">@CoveredFamilies</div>
                        <div class="kpi-label">कुल कवर्ड परिवार </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-box bg-info text-white">
                    <div class="kpi-value">@TotalMembers</div>
                        <div class="kpi-label">कुल पात्र सदस्य </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="kpi-box bg-warning">
                    <div class="kpi-value">@CoveredMembers</div>
                        <div class="kpi-label">कुल कवर्ड सदस्य</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= SEARCH ================= -->
    <div class="container-fluid mb-2">
        <input class="form-control"
               placeholder="ब्लॉक खोजें..."/>
    </div>

    <!-- ================= BLOCK DASHBOARD ================= -->
    <div class="container-fluid">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h4 class="fw-bold text-primary text-center mb-3">
                    ब्लॉक-वार कवरेज स्थिति
                </h4>
                    <!-- ================= PERFORMANCE SNAPSHOT ================= -->
                    <div class="container-fluid mb-4">
                        <div class="row g-3">

                            <!-- TOP 5 -->
                            <div class="col-md-6">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <h6 class="fw-bold text-success">
                                            Top 5 Best Performing Blocks
                                        </h6>

                                        <ol class="list-group list-group-numbered">
                                            @foreach (var b in BestBlocks)
                                            {
                                                <li class="list-group-item d-flex justify-content-between">
                                                    <span>@b.BlockName</span>
                                                    <span class="fw-bold text-success">
                                                        @b.FamilyCoveragePercent%
                                                    </span>
                                                </li>
                                            }
                                        </ol>
                                    </div>
                                </div>
                            </div>

                            <!-- WORST 5 -->
                            <div class="col-md-6">
                                <div class="card shadow-sm border-danger">
                                    <div class="card-body">
                                        <h6 class="fw-bold text-danger">
                                            Blocks Needing Attention
                                        </h6>

                                        <ol class="list-group list-group-numbered">
                                            @foreach (var b in WorstBlocks)
                                            {
                                                <li class="list-group-item d-flex justify-content-between">
                                                    <span>@b.BlockName</span>
                                                    <span class="fw-bold text-danger">
                                                        @b.FamilyCoveragePercent%
                                                    </span>
                                                </li>
                                            }
                                        </ol>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="text-center mb-3">
                        <button class="btn btn-outline-primary px-4"
                                @onclick="ToggleAllBlocks">
                            @(ShowAllBlocks ? "Hide All Blocks" : "View All Blocks")
                        </button>
                    </div>
                    </div>
              @if (ShowAllBlocks)
                {
                        <div class="container-fluid">
                         <div class="row g-3">
                        @if (!Dash.Any())
                        {
                            <div class="col-12">
                                <div class="alert alert-warning text-center">
                                    No dashboard data available
                                </div>
                            </div>
                        }
                        else
                        {
                            @foreach (var block in Dash)
                            {
                                <div class="col-xl-3 col-lg-4 col-md-6">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-body p-3">

                                            <!-- BLOCK NAME -->
                                            <div class="fw-bold text-primary mb-2">
                                                @block.BlockName
                                            </div>

                                            <!-- FAMILY COVERAGE -->
                                            <small class="text-muted">Family Coverage</small>
                                            <div class="progress mb-1" style="height:6px">
                                                <div class="progress-bar @GetBarColor(@block.FamilyCoveragePercent)"
                                                     style="width:@block.FamilyCoveragePercent%">
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                @block.CoveredFamilies / @block.TotalFamilies
                                                (@block.FamilyCoveragePercent%)
                                            </small>

                                            <!-- MEMBER COVERAGE -->
                                            <small class="text-muted d-block mt-2">Member Coverage</small>
                                            <div class="progress mb-1" style="height:6px">
                                                <div class="progress-bar @GetBarColor(@block.MemberCoveragePercent)"
                                                     style="width:@block.MemberCoveragePercent%">
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                @block.CoveredMembers / @block.TotalMembers
                                                (@block.MemberCoveragePercent%)
                                            </small>

                                            <!-- VERIFIED FAMILIES -->
                                            @* <small class="text-muted d-block mt-2">Verified Families</small>
                                            <div class="progress mb-1" style="height:6px">
                                                <div class="progress-bar bg-warning"
                                                     style="width:@block.VerifiedCoveragePercent%">
                                                </div>
                                            </div>
                                            <small class="text-muted">
                                                @block.VerifiedFamilies / @block.TotalFamilies
                                                (@block.VerifiedCoveragePercent%)
                                            </small> *@

                                        </div>
                                    </div>
                                </div>
                            }
                        }
                </div>

            </div>
                    }
        </div>
    </div>
  }
  </div>
<div class="gov-social-section mt-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body">

            <div class="pmjay-inline-bar">

                <div class="inline-block">
                    <span class="inline-title">Follow Us:</span>
                    <a href="https://x.com/AgraAyushman" target="_blank" class="social-link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="18" height="18" fill="currentColor">
                            <path d="M12.6 0.75h2.454l-5.36 6.142L16 15.25h-4.937l-3.867-5.07-4.425 5.07H0.316l5.733-6.57L0 0.75h5.063l3.495 4.633L12.601 0.75Zm-0.86 13.028h1.36L4.323 2.145H2.865z" />
                        </svg>
                    </a>
                </div>

                <div class="divider"></div>

                <div class="inline-block">
                    <span class="inline-title">Download:</span>
                    <a href="https://play.google.com/store/apps/details?id=com.beneficiaryapp" target="_blank">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg">
                    </a>
                    <a href="https://play.google.com/store/apps/details?id=com.ayushmaanbharat" target="_blank">
                        <img src="https://ayushmanup.in/icon/sarathi2.jpg">
                    </a>
                    <a href="https://www.ayushmanup.in/comicbook.pdf" target="_blank">
                        <img src="https://ayushmanup.in/icon/ayush-man.jpg">
                    </a>
                </div>

            </div>

        </div>
    </div>
</div>
<!-- ================= FOOTER ================= -->
<footer class="bg-light border-top text-center text-secondary small py-2 mt-4">
    डेटा अंतिम बार अपडेट: @DateTime.Now.ToString("dd MMM yyyy, hh:mm tt") <br />
    © @DateTime.Now.Year AB-PMJAY, Agra District |
    CMO Office, Agra
    © @DateTime.Now.Year Ayushman Bharat – Pradhan Mantri Jan Arogya Yojana (AB-PMJAY), Agra District |
    All rights reserved | Developed & Maintained by Office Of The Chief Medical Officer, Agra
</footer>
@code 
{
    bool ShowAllBlocks = false;

    List<BlockDashboardDto> BestBlocks =>
    Dash.OrderByDescending(x => x.FamilyCoveragePercent).Take(5).ToList();

    List<BlockDashboardDto> WorstBlocks =>
        Dash.OrderBy(x => x.FamilyCoveragePercent).Take(5).ToList();
    int DistrictFamilyPercent =>
        TotalFamilies == 0 ? 0 :
        (int)Math.Round((double)CoveredFamilies * 100 / TotalFamilies);

    int DistrictMemberPercent =>
        TotalMembers == 0 ? 0 :
        (int)Math.Round((double)CoveredMembers * 100 / TotalMembers);
    int TotalFamilies => Dash.Sum(x => x.TotalFamilies);
    int CoveredFamilies => Dash.Sum(x => x.CoveredFamilies);
    int TotalMembers => Dash.Sum(x => x.TotalMembers);
    int CoveredMembers => Dash.Sum(x => x.CoveredMembers);
    bool IsLoading = true;  
    List<BlockDashboardDto> Dash = new();
    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsLoading = true;
            Dash = await Api.GetBlockDashboardAsync();
        }
        finally
        {
            IsLoading = false;
        }
    }
    string GetBarColor(int p) =>
    p >= 75 ? "bg-success" :
    p >= 50 ? "bg-warning" :
    "bg-danger";
    void ToggleAllBlocks()
    {
        ShowAllBlocks = !ShowAllBlocks;
    }
}

