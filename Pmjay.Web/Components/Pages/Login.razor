@page "/"
@attribute [AllowAnonymous]
@layout Layout.EmptyLayout
@using Microsoft.AspNetCore.Authorization
@using Pmjay.Web.Data
@inject AuthApiService AuthService
@inject NavigationManager NavigationManager
@inject LoginStateService LoginState
<div class="login-wrapper">
    <div class="login-card">

        <!-- Branding Panel -->
        <div class="login-brand">
            <img src="PMJAYl.png" class="gov-logo" />
            <h2>AB-PMJAY Portal</h2>
            <p>Agra, Uttar Pradesh</p>
            <p>Secure Verification System</p>
        </div>

        <!-- Login Form -->
        <div class="login-form">
            <h3>User Login</h3>
            <p class="subtitle">Enter your credentials to continue</p>

            <EditForm Model="@loginModel" OnValidSubmit="OnLogin">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="form-group">
                    <label>Username</label>
                    <input class="form-control"
                           placeholder="Enter username"
                           @bind="loginModel.UserName" />
                </div>

                <div class="form-group">
                    <label>Password</label>

                    <div class="password-wrapper">
                        <input class="form-control"
                               type="@PasswordType"
                               placeholder="Enter password"
                               @bind="loginModel.Password" />

                        <button type="button"
                                class="toggle-password"
                                @onclick="TogglePassword">
                            @(ShowPassword ? "🙈" : "👁️")
                        </button>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <div class="error-message">@ErrorMessage</div>
                }

                <button class="login-btn" type="submit" disabled="@IsLoading">
                    @(IsLoading ? "Logging in..." : "Login")
                </button>
            </EditForm>

            <div class="footer-text">
                © PMJAY
            </div>
        </div>

    </div>
</div>

@code {

    LoginRequest loginModel = new();

    string? ErrorMessage;
    bool ShowPassword;
    bool IsLoading;

    string PasswordType => ShowPassword ? "text" : "password";

    void TogglePassword()
    {
        ShowPassword = !ShowPassword;
    }

    async Task OnLogin()
    {
        
        ErrorMessage = null;
        IsLoading = true;

        var result = await AuthService.Login(loginModel);

        IsLoading = false;

        if (result == null || !result.IsAuthenticated)
        {
            ErrorMessage = "Invalid username or password";
            return;
        }

        // Save login + token
        await LoginState.SetLogin(result);

        // Role based redirect
        if (result.RoleName == "Admin")
            NavigationManager.NavigateTo("/home", true);
        else
            NavigationManager.NavigateTo("/", true);
    }
}